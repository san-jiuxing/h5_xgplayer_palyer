<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui">
    <meta name="referrer" content="no-referrer">
    <title>xgplayer ç½‘é¡µæ’­æ”¾å™¨</title>
	
	<link rel="icon" href="./favicon.ico" />
    
    <link rel="stylesheet" href="./css/xgplayer.css" />
	<link rel="stylesheet" href="./css/mycss.css" />
    
</head>
<body>

    <div class="container">
        <h2 class="header">xgplayer ç½‘é¡µæ’­æ”¾å™¨</h2>

        <div class="control-panel">
            <label class="input-label" for="videoUrl">è¯·è¾“å…¥è§†é¢‘æµåœ°å€ (æ”¯æŒ .mp4 / .m3u8 / .flv)ï¼š</label>
            <div class="input-group">
                <input type="text" id="videoUrl" placeholder="https://..." />
                <button id="playBtn">æ’­æ”¾</button>
            </div>
            <span id="errorTip" class="error-tip"></span>
        </div>

        <div class="player-wrapper">
            <div id="mse"></div>
        </div>
    </div>

    <script charset="utf-8" src="./js/xgplayer.js"></script>
    <script charset="utf-8" src="./js/xgplayer-flv.js"></script>
    <script charset="utf-8" src="./js/xgplayer-hls.js"></script>
	
	<script charset="utf-8" src="./js/md5.js"></script>

    <script>
        let player = null;
        const videoUrlInput = document.getElementById('videoUrl');
        const errorTip = document.getElementById('errorTip');
        
        // é»˜è®¤æ¼”ç¤ºè§†é¢‘ URL
        const DEFAULT_URL = "//lf3-static.bytednsdoc.com/obj/eden-cn/nupenuvpxnuvo/xgplayer_doc/xgplayer-demo.mp4";
		
		let videoCache = JSON.parse(localStorage.getItem(".cache")) || {};
		
		// ä¿å­˜è§†é¢‘è¿›åº¦
		function saveVideoProgress(videoId, currentTime) {
		  try {
		    videoCache[videoId] = currentTime;
		    localStorage.setItem('.cache', JSON.stringify(videoCache));
		  } catch (e) {
		  }
		}

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯çš„å°å·¥å…·
        function showError(message) {
            errorTip.textContent = message;
            errorTip.style.display = 'block';
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            errorTip.style.display = 'none';
        }
		
		function formatTime(seconds) {
		  const h = Math.floor(seconds / 3600);
		  const m = Math.floor((seconds % 3600) / 60);
		  const s = Math.floor(seconds % 60);
		  
		  if (h > 0) {
		    return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
		  }
		  return `${m}:${s.toString().padStart(2, '0')}`;
		}

        function PlayVideo(VideoUrl) {
            hideError();

            if (player) {
                player.destroy();
                player = null;
            }
			
			const url_b64_hash = b64_md5(VideoUrl);
			
			const savedProgress = videoCache[url_b64_hash] || 0;
            
            // ä¿®å¤ï¼šä½¿ç”¨ä¼ å…¥çš„ VideoUrlï¼Œè€Œä¸æ˜¯é‡æ–°å»è·å– DOM é‡Œçš„å€¼
            const config = {
                id: "mse",
                url: VideoUrl, 
				videoId:url_b64_hash,
                playsinline: true,
                plugins: [],
                fluid: true, 
                "x5-video-player-type": "h5",
                "x5-video-player-fullscreen": "true",
                download: true,
                playbackRate: [0.5, 0.75, 1, 1.25, 1.5, 2, 3, 5],
				defaultPlaybackRate: parseFloat(localStorage.getItem("currentRate")) || 1,
				mobile:{
					disablePress:false,
					pressRate: 3
				},
                autoplay: false, // æ—¢ç„¶æ˜¯ä¸»åŠ¨ç‚¹å‡»æ’­æ”¾ï¼Œç›´æ¥å¼€å¯è‡ªåŠ¨æ’­æ”¾ä½“éªŒæ›´å¥½
                volume: 0.6
            }
            
            // ä¿®å¤ï¼šè½¬ä¸ºå°å†™åå†åˆ¤æ–­ï¼Œé˜²æ­¢å‡ºç° .MP4 æˆ– .M3U8 å¯¼è‡´åˆ¤æ–­å¤±è´¥
            const lowerUrl = VideoUrl.toLowerCase();

            if (lowerUrl.includes(".m3u8")) {
                config.plugins.push(window.HlsPlayer);
            } else if (lowerUrl.includes(".flv")) {
                config.plugins.push(window.FlvPlayer);
            } else if (!lowerUrl.includes(".mp4") && !lowerUrl.includes(".webm") && !lowerUrl.includes(".ogg")) {
                // å¦‚æœæ—¢ä¸æ˜¯ m3u8/flvï¼Œä¹Ÿä¸æ˜¯å¸¸è§çš„åŸç”Ÿæ ¼å¼ï¼Œç»™å‡ºè­¦å‘Šä½†ä»ç„¶å°è¯•æ’­æ”¾
                console.warn("æœªæ£€æµ‹åˆ°å¸¸è§è§†é¢‘åç¼€ï¼Œå°†å°è¯•ä½¿ç”¨åŸç”Ÿ HTML5 æ’­æ”¾");
            }

            try {
                player = new Player(config);
                // æ’­æ”¾æˆåŠŸåï¼Œå°†å½“å‰ URL å­˜å…¥ localStorage
                localStorage.setItem('saved_video_url', VideoUrl);
				// ğŸ’¡ æ ¸å¿ƒä¿®å¤ 2ï¼šç›‘å¬åº•å±‚çš„ error äº‹ä»¶ï¼Œç»Ÿä¸€æ•è· 403/è·¨åŸŸ/è§£æå¤±è´¥
				player.on('error', (err) => {
					// å¯ä»¥åœ¨æ§åˆ¶å°æ‰“å°ä¸€ä¸‹çœŸå®çš„é”™è¯¯åŸå› ï¼Œæ–¹ä¾¿ä½ è°ƒè¯•
					console.warn("æ’­æ”¾å™¨æ‹¦æˆªåˆ°é”™è¯¯ï¼š", err);
					
					// ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ UI æç¤ºç”¨æˆ·ï¼Œå‘Šåˆ«ä¹±ç ï¼
					showError("ğŸ›‘ è§†é¢‘åŠ è½½å¤±è´¥ï¼šè¯¥é“¾æ¥æ— è®¿é—®æƒé™(403)ã€å­˜åœ¨é˜²ç›—é“¾æˆ–å·²å¤±æ•ˆã€‚");
				});
				player.on('error', (err) => {
					// å¯ä»¥åœ¨æ§åˆ¶å°æ‰“å°ä¸€ä¸‹çœŸå®çš„é”™è¯¯åŸå› ï¼Œæ–¹ä¾¿ä½ è°ƒè¯•
					console.warn("æ’­æ”¾å™¨æ‹¦æˆªåˆ°é”™è¯¯ï¼š", err);
					
					// ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ UI æç¤ºç”¨æˆ·ï¼Œå‘Šåˆ«ä¹±ç ï¼
					showError("ğŸ›‘ è§†é¢‘åŠ è½½å¤±è´¥ï¼šè¯¥é“¾æ¥æ— è®¿é—®æƒé™(403)ã€å­˜åœ¨é˜²ç›—é“¾æˆ–å·²å¤±æ•ˆã€‚");
				});
				// æ’­æ”¾å™¨äº‹ä»¶ç›‘å¬
				player.on('timeupdate', () => {
				  // æ¯5ç§’ä¿å­˜ä¸€æ¬¡è¿›åº¦ï¼Œé¿å…é¢‘ç¹å†™å…¥
				  const currentTime = Math.floor(player.currentTime);
				  if (currentTime % 5 === 0) {
				    saveVideoProgress(player.config.videoId, currentTime);
				  }
				});
				
				player.on('ratechange', () => {
					const currentRate = player.playbackRate;
					localStorage.setItem("currentRate", currentRate);
				});
				
				// æ’­æ”¾å™¨å‡†å¤‡å¥½åï¼Œè·³è½¬åˆ°ä¸Šæ¬¡çš„è¿›åº¦
				player.on('loadeddata', () => {
				  // å¦‚æœä¿å­˜çš„è¿›åº¦å¤§äº0ï¼Œä¸”ä¸æ˜¯è§†é¢‘æœ«å°¾ï¼ˆé¢„ç•™æœ€å10ç§’ä¸è·³è½¬ï¼‰
				  if (savedProgress > 0 && savedProgress < player.duration - 10) {
				    player.currentTime = savedProgress;
				    
				    // å¯é€‰ï¼šæ˜¾ç¤ºæç¤º
				    console.log(`å·²è·³è½¬åˆ°ä¸Šæ¬¡æ’­æ”¾ä½ç½®ï¼š${formatTime(savedProgress)}`);
				  }
				});
				
				// è§†é¢‘ç»“æŸæ—¶æ¸…é™¤è¯¥è§†é¢‘çš„è¿›åº¦
				player.on('ended', () => {
				  delete videoCache[player.config.videoId];
				  localStorage.setItem('.cache', JSON.stringify(videoCache));
				});
            } catch (err) {
                showError("æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥è§†é¢‘åœ°å€æ˜¯å¦æœ‰æ•ˆã€‚");
                console.error(err);
            }
        }
        
        // --- é¡µé¢åˆå§‹åŒ–ä¸äº‹ä»¶ç»‘å®š ---

        // é¡µé¢åŠ è½½æ—¶ï¼šå°è¯•ä» localStorage è¯»å–ä¸Šä¸€æ¬¡æ’­æ”¾çš„ URLï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨é»˜è®¤çš„
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('saved_video_url');
            if (savedUrl) {
                videoUrlInput.value = savedUrl;
                PlayVideo(savedUrl);
            } else {
                videoUrlInput.value = DEFAULT_URL;
                // é¦–æ¬¡åŠ è½½å¦‚æœä¸å¸Œæœ›å®ƒè‡ªåŠ¨æ’­æ”¾å‡ºå£°éŸ³å“åˆ°ç”¨æˆ·ï¼Œå¯ä»¥ä¸åœ¨æ­¤å¤„è°ƒç”¨ PlayVideoï¼Œ
                // æˆ–è€…è°ƒç”¨åå°† autoplay è®¾ç½®ä¸º false
                PlayVideo(DEFAULT_URL);
            }
        });

        // ç»‘å®šâ€œæ’­æ”¾â€æŒ‰é’®äº‹ä»¶
        const playBtn = document.getElementById('playBtn');

        playBtn.addEventListener('click', () => {
            const newUrl = videoUrlInput.value.trim();
            if (newUrl) {
                PlayVideo(newUrl);
            } else {
                showError('è§†é¢‘ URL ä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥ï¼');
                videoUrlInput.focus();
            }
        });

        // åœ¨è¾“å…¥æ¡†å†…æŒ‰å›è½¦é”®ä¹Ÿèƒ½è§¦å‘æ’­æ”¾
        videoUrlInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                playBtn.click();
            }
        });
    </script>
</body>
</html>


